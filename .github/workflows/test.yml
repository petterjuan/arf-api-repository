# .github/workflows/test.yml
name: Run Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays to catch dependency issues
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual triggering

env:
  # Global environment variables
  PYTHON_VERSION: '3.11'
  TEST_DATABASE_URL: "sqlite+aiosqlite:///:memory:"
  ENVIRONMENT: "testing"
  TESTING: "1"
  SKIP_DATABASE_INIT: "1"
  VALIDATION_MODE: "1"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiosqlite  # Required for SQLite async support
        pip install -e ".[dev]"  # Install with dev dependencies from pyproject.toml
    
    - name: Run unit tests
      env:
        TEST_DATABASE_URL: "sqlite+aiosqlite:///:memory:"
        SKIP_DATABASE_INIT: '1'
        TESTING: '1'
        VALIDATION_MODE: '1'
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=30 \
          -m "not integration" \
          --disable-warnings
    
    - name: Upload coverage to Codecov
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        flags: unittests
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results-${{ matrix.python-version }}
        path: |
          coverage.xml
          htmlcov/
        retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository  # Skip for external PRs
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: arf_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: neo4j/test
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7687:7687
          - 7474:7474
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiosqlite
        pip install -e ".[dev]"  # Install with dev dependencies from pyproject.toml
    
    - name: Wait for services
      run: |
        echo "Waiting for PostgreSQL..."
        timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 2; done'
        echo "PostgreSQL is ready!"
        
        echo "Waiting for Redis..."
        timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping | grep PONG; do sleep 2; done'
        echo "Redis is ready!"
        
        echo "Waiting for Neo4j..."
        timeout 60 bash -c 'until cypher-shell -a bolt://localhost:7687 -u neo4j -p test "RETURN 1;" 2>/dev/null; do sleep 2; done'
        echo "Neo4j is ready!"
    
    - name: Run integration tests
      env:
        TEST_DATABASE_URL: "postgresql+asyncpg://test:test@localhost:5432/arf_test"
        REDIS_URL: "redis://localhost:6379/0"
        NEO4J_URL: "bolt://localhost:7687"
        NEO4J_USER: "neo4j"
        NEO4J_PASSWORD: "test"
        TESTING: '1'
        ENVIRONMENT: 'testing'
        SKIP_DATABASE_INIT: '0'
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          -m "integration" \
          --cov=src \
          --cov-append \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=20 \
          --disable-warnings
    
    - name: Upload integration coverage
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        flags: integration
    
    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          coverage.xml
          htmlcov/
        retention-days: 7

  database-tests:
    name: Database Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: arf_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiosqlite
        pip install -e ".[dev]"
    
    - name: Wait for PostgreSQL
      run: |
        echo "Waiting for PostgreSQL..."
        timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 2; done'
        echo "PostgreSQL is ready!"
    
    - name: Run database tests
      env:
        TEST_DATABASE_URL: "postgresql+asyncpg://test:test@localhost:5432/arf_test"
        TESTING: '1'
        ENVIRONMENT: 'testing'
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          -m "database" \
          --cov=src \
          --cov-append \
          --cov-report=term-missing \
          --cov-report=xml \
          --disable-warnings

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-report.json || echo "Bandit scan completed"
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: bandit-report.json
        retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, database-tests, security-scan]
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "# ðŸ§ª ARF API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Unit tests status
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "## âœ… Unit Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Python versions: 3.11, 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: Minimum 30%" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Unit Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- Check unit test logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration tests status
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "## âœ… Integration Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Databases: PostgreSQL, Redis, Neo4j" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: Minimum 20%" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
          echo "## â¸ï¸ Integration Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "- Skipped for external PRs (security)" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Integration Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- Check integration test logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Database tests status
        if [[ "${{ needs.database-tests.result }}" == "success" ]]; then
          echo "## âœ… Database Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL connectivity" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Database Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- Check database test logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security scan status
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "## âœ… Security Scan: COMPLETED" >> $GITHUB_STEP_SUMMARY
          echo "- Tool: Bandit" >> $GITHUB_STEP_SUMMARY
          echo "- Report available in artifacts" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review test artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
        echo "2. Check coverage reports in Codecov" >> $GITHUB_STEP_SUMMARY
        echo "3. Address any security findings" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Core unit tests passed!**" >> $GITHUB_STEP_SUMMARY
        fi
