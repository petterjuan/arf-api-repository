# .github/workflows/test.yml
name: Run Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays to catch dependency issues
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-cov pytest-xdist
        pip install -r requirements.txt
    
    - name: Run unit tests
      env:
        SKIP_DATABASE_INIT: '1'
        TESTING: '1'
        VALIDATION_MODE: '1'
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-fail-under=70 \
          -n auto
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        flags: unittests
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results-${{ matrix.python-version }}
        path: |
          coverage.xml
          .coverage
        retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: none
          NEO4J_PLUGINS: '["apoc"]'
        options: >-
          --health-cmd "cypher-shell -u neo4j -p '' 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7687:7687
          - 7474:7474
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-postgresql pytest-redis
        pip install -r requirements.txt
    
    - name: Wait for services
      run: |
        echo "Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker exec $(docker ps -q -f name=postgres) pg_isready -U testuser -d testdb; do sleep 1; done'
        echo "Waiting for Redis..."
        timeout 30 bash -c 'until docker exec $(docker ps -q -f name=redis) redis-cli ping | grep PONG; do sleep 1; done'
        echo "Waiting for Neo4j..."
        timeout 30 bash -c 'until docker exec $(docker ps -q -f name=neo4j) cypher-shell -u neo4j -p "" "RETURN 1" 2>/dev/null; do sleep 1; done'
    
    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
        REDIS_URL: redis://localhost:6379/0
        NEO4J_URL: bolt://localhost:7687
        TESTING: '1'
        ENVIRONMENT: 'testing'
      run: |
        python -m pytest tests/ \
          -v \
          --tb=short \
          -m "integration" \
          --cov=src \
          --cov-append \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-fail-under=60
    
    - name: Upload integration coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        flags: integration
    
    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          coverage.xml
        retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: unit-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Run Bandit security scan
      run: |
        python -m pip install bandit
        bandit -r src/ -f json -o bandit-report.json || true
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: bandit-report.json
        retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "# ðŸ§ª ARF API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Unit tests status
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "## âœ… Unit Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Python versions: 3.11, 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: Minimum 70%" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Unit Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration tests status
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "## âœ… Integration Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Databases: PostgreSQL, Redis, Neo4j" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: Minimum 60%" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security scan status
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "## âœ… Security Scan: COMPLETED" >> $GITHUB_STEP_SUMMARY
          echo "- Tool: Bandit" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review test artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
        echo "2. Check coverage reports in Codecov" >> $GITHUB_STEP_SUMMARY
        echo "3. Address any security findings" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All tests passed! Ready for deployment.**" >> $GITHUB_STEP_SUMMARY
        fi
