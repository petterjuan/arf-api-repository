- name: Validate core imports
  run: |
    echo "Validating core imports..."
    cat > validate_imports.py << 'EOF'
#!/usr/bin/env python3
"""
ARF API Import Validation Script
Validates that all core imports work correctly in CI environment.
Psychology: Comprehensive validation with clear reporting and graceful degradation.
Intention: Ensure the application structure is sound before proceeding with tests.
"""

import sys
import os
import traceback
from pathlib import Path
from typing import List, Dict, Any, Optional, Tuple

# ============================================================================
# CONSTANTS AND CONFIGURATION
# ============================================================================

VALIDATION_MODE = True
BANNER_WIDTH = 60

# Environment variables to prevent database initialization
ENV_VARS_TO_SET = {
    'SKIP_DATABASE_INIT': '1',
    'TESTING': '1',
    'VALIDATION_MODE': '1',
    'ENVIRONMENT': 'validation'
}

# Critical endpoints that should exist
CRITICAL_ENDPOINTS = [
    '/health',
    '/docs',
    '/openapi.json',
    '/metrics',
    '/api/v1/auth/login',
    '/api/v1/incidents'
]

# Modules to validate with their expected exports
MODULES_TO_VALIDATE = [
    {
        'name': 'main',
        'import_path': 'main',
        'expected_export': 'app',
        'is_critical': True,
        'description': 'Core FastAPI application'
    },
    {
        'name': 'auth.models',
        'import_path': 'auth.models',
        'expected_export': 'User',
        'is_critical': True,
        'description': 'Authentication models'
    },
    {
        'name': 'database',
        'import_path': 'database',
        'expected_export': 'Base',
        'is_critical': True,
        'description': 'Database base class'
    },
    {
        'name': 'monitoring',
        'import_path': 'monitoring',
        'expected_export': 'router',
        'description': 'Monitoring router'
    },
    {
        'name': 'integrations.email',
        'import_path': 'integrations.email',
        'expected_export': 'EmailIntegration',
        'description': 'Email integration'
    },
    {
        'name': 'services.webhook_service',
        'import_path': 'services.webhook_service',
        'expected_export': 'get_webhook_service',
        'description': 'Webhook service'
    },
    {
        'name': 'services.neo4j_service',
        'import_path': 'services.neo4j_service',
        'expected_export': 'get_execution_ladder_service',
        'description': 'Neo4j service'
    }
]

# Test files that should exist
EXPECTED_TEST_FILES = [
    'tests/conftest.py',
    'tests/test_auth.py',
    'tests/test_incidents.py',
    'tests/test_execution_ladder.py',
    'tests/test_rollback.py',
    'tests/test_monitoring.py'
]

# ============================================================================
# VALIDATION FUNCTIONS
# ============================================================================

def print_banner(title: str, width: int = BANNER_WIDTH) -> None:
    """Print a formatted banner for better visual separation."""
    print("=" * width)
    print(f"{title:^{width}}")
    print("=" * width)

def print_result(success: bool, message: str, indent: int = 0) -> None:
    """Print a formatted result message."""
    indent_str = " " * indent
    icon = "‚úÖ" if success else "‚ùå"
    if not success and "WARN" in message:
        icon = "‚ö†Ô∏è"
    print(f"{indent_str}{icon} {message}")

def setup_environment() -> None:
    """Set up environment variables and Python path."""
    # Set environment variables
    for key, value in ENV_VARS_TO_SET.items():
        os.environ[key] = value
    
    # Add src directory to Python path
    src_path = Path.cwd() / 'src'
    if src_path.exists():
        sys.path.insert(0, str(src_path))
    else:
        raise FileNotFoundError(f"src directory not found at: {src_path}")

def validate_module_import(module_config: Dict[str, Any]) -> Tuple[bool, str, Optional[Exception]]:
    """Validate that a module can be imported successfully."""
    try:
        # Dynamic import
        module = __import__(module_config['import_path'], fromlist=[module_config['expected_export']])
        
        # Check if expected export exists
        if hasattr(module, module_config['expected_export']):
            return True, f"{module_config['name']} imports successfully", None
        else:
            return False, f"{module_config['name']}: missing export '{module_config['expected_export']}'", None
            
    except ImportError as e:
        return False, f"{module_config['name']} import failed", e
    except Exception as e:
        return False, f"{module_config['name']} unexpected error", e

def validate_fastapi_app() -> Tuple[bool, str, Optional[Exception], Dict[str, Any]]:
    """Validate the FastAPI application and its endpoints."""
    try:
        from main import app
        
        # Basic app info
        app_info = {
            'route_count': len(app.routes),
            'title': app.title,
            'version': app.version,
            'found_endpoints': []
        }
        
        # Check for critical endpoints
        routes = [route.path for route in app.routes]
        found_critical_endpoints = []
        
        for endpoint in CRITICAL_ENDPOINTS:
            if any(endpoint in route for route in routes):
                found_critical_endpoints.append(endpoint)
        
        app_info['found_endpoints'] = found_critical_endpoints
        
        success_message = (
            f"main.py imports successfully\n"
            f"   - Found FastAPI app: {app.title} v{app.version}\n"
            f"   - Total routes: {len(app.routes)}\n"
            f"   - Critical endpoints found: {len(found_critical_endpoints)}/{len(CRITICAL_ENDPOINTS)}"
        )
        
        return True, success_message, None, app_info
        
    except Exception as e:
        return False, f"main.py import failed", e, {}

def validate_test_files() -> Tuple[bool, List[str], List[str]]:
    """Validate that test files exist."""
    tests_dir = Path('tests')
    existing_files = []
    missing_files = []
    
    if not tests_dir.exists():
        return False, existing_files, missing_files
    
    for test_file in EXPECTED_TEST_FILES:
        if Path(test_file).exists():
            existing_files.append(test_file)
        else:
            missing_files.append(test_file)
    
    return len(missing_files) == 0, existing_files, missing_files

def validate_directory_structure() -> Tuple[bool, List[str], List[str]]:
    """Validate important directories exist."""
    expected_dirs = [
        'src',
        'src/api/v1',
        'src/auth',
        'src/database',
        'src/integrations',
        'src/models',
        'src/services',
        'src/middleware',
        'tests'
    ]
    
    existing_dirs = []
    missing_dirs = []
    
    for directory in expected_dirs:
        if Path(directory).exists():
            existing_dirs.append(directory)
        else:
            missing_dirs.append(directory)
    
    return len(missing_dirs) == 0, existing_dirs, missing_dirs

# ============================================================================
# MAIN VALIDATION LOGIC
# ============================================================================

def main() -> int:
    """Main validation function."""
    try:
        # Setup
        print_banner("ARF API Import Validation")
        print(f"Python: {sys.version}")
        print(f"Working directory: {Path.cwd()}")
        print()
        
        setup_environment()
        
        # Track results
        results = {
            'passed': 0,
            'failed': 0,
            'warnings': 0,
            'details': []
        }
        
        # 1. Validate directory structure
        print_banner("Directory Structure Validation")
        dir_success, existing_dirs, missing_dirs = validate_directory_structure()
        
        if dir_success:
            print_result(True, "All required directories exist")
            for directory in existing_dirs:
                print(f"   üìÅ {directory}")
        else:
            print_result(False, f"Missing {len(missing_dirs)} directories")
            for directory in missing_dirs:
                print(f"   ‚ùå Missing: {directory}")
            results['warnings'] += 1
        
        print()
        
        # 2. Validate FastAPI app (critical)
        print_banner("FastAPI Application Validation")
        app_success, app_message, app_error, app_info = validate_fastapi_app()
        
        if app_success:
            print_result(True, app_message)
            results['passed'] += 1
            
            # Show found endpoints
            if app_info.get('found_endpoints'):
                print("   Found critical endpoints:")
                for endpoint in app_info['found_endpoints']:
                    print(f"   ‚Ä¢ {endpoint}")
        else:
            print_result(False, app_message)
            if app_error:
                print(f"   Error: {app_error}")
                traceback.print_exc()
            results['failed'] += 1
            return 1  # Critical failure
        
        print()
        
        # 3. Validate module imports
        print_banner("Module Import Validation")
        
        for module_config in MODULES_TO_VALIDATE:
            success, message, error = validate_module_import(module_config)
            
            if success:
                print_result(True, message)
                results['passed'] += 1
            elif module_config.get('is_critical', False):
                print_result(False, message)
                if error:
                    print(f"   Error: {error}")
                results['failed'] += 1
            else:
                print_result(False, f"{message} (optional)")
                results['warnings'] += 1
        
        print()
        
        # 4. Validate test files
        print_banner("Test Structure Validation")
        test_success, existing_tests, missing_tests = validate_test_files()
        
        if test_success:
            print_result(True, f"All {len(existing_tests)} test files exist")
        else:
            if existing_tests:
                print_result(True, f"Found {len(existing_tests)} test files")
                for test_file in existing_tests[:5]:  # Show first 5
                    print(f"   ‚úÖ {Path(test_file).name}")
                if len(existing_tests) > 5:
                    print(f"   ... and {len(existing_tests) - 5} more")
            
            if missing_tests:
                print_result(False, f"Missing {len(missing_tests)} test files")
                for test_file in missing_tests[:3]:  # Show first 3 missing
                    print(f"   ‚ùå {Path(test_file).name}")
                if len(missing_tests) > 3:
                    print(f"   ... and {len(missing_tests) - 3} more")
                results['warnings'] += 1
        
        print()
        
        # 5. Summary
        print_banner("Validation Summary")
        print(f"Total checks: {results['passed'] + results['failed'] + results['warnings']}")
        print(f"‚úÖ Passed: {results['passed']}")
        print(f"‚ùå Failed: {results['failed']}")
        print(f"‚ö†Ô∏è  Warnings: {results['warnings']}")
        
        if results['failed'] > 0:
            print_result(False, "VALIDATION FAILED - Critical errors found")
            return 1
        elif results['warnings'] > 0:
            print_result(True, "VALIDATION PASSED with warnings")
            return 0
        else:
            print_result(True, "VALIDATION PASSED - All checks successful!")
            return 0
            
    except Exception as e:
        print_banner("VALIDATION ERROR")
        print(f"‚ùå Unexpected error during validation: {e}")
        traceback.print_exc()
        return 1

# ============================================================================
# ENTRY POINT
# ============================================================================

if __name__ == "__main__":
    sys.exit(main())
EOF
    
    python validate_imports.py
